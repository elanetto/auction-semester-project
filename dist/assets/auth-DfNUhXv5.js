function b(o){const t=o.currentTarget,n=t.previousElementSibling;console.log("Show Password Button Clicked:",t),console.log("Password Input Element:",n),n?n.type==="password"?(n.type="text",t.querySelector(".fa-eye-slash").classList.remove("hide"),t.querySelector(".fa-eye").classList.add("hide")):(n.type="password",t.querySelector(".fa-eye-slash").classList.add("hide"),t.querySelector(".fa-eye").classList.remove("hide")):console.error("Password input not found.")}const B="https://v2.api.noroff.dev",S=`${B}/auth`,L=`${S}/login`,P=`${S}/register`,T=()=>{const o=document.getElementById("login-email"),t=document.getElementById("login-password"),n=document.querySelector(".show-password"),s=document.getElementById("login-error"),e=document.getElementById("login-btn");return{email:o,password:t,showPasswordBtn:n,errorMessage:s,loginBtn:e}},A=()=>{const o=document.getElementById("username"),t=document.getElementById("register-email"),n=document.getElementById("register-password"),s=document.querySelector(".show-password"),e=document.getElementById("error-message"),r=document.getElementById("success-message"),a=document.getElementById("register-btn");return{username:o,email:t,password:n,showPasswordBtn:s,errorMessage:e,successMessage:r,registerBtn:a}};function $(){const{username:o,email:t,password:n,showPasswordBtn:s,errorMessage:e,successMessage:r,registerBtn:a}=A();if(!s||!n){console.error("Required elements for show-password functionality are missing.");return}s.addEventListener("click",b),a.addEventListener("click",async function(i){if(i.preventDefault(),e.style.display="none",r.style.display="none",o.value.length<2||t.value.length<2||n.value.length<2){e.style.display="block",e.innerHTML="All fields must be filled in.",console.log("All fields must be filled in.");return}if(n.value.length<9){e.innerHTML="The password must contain more than 9 characters.",e.style.display="block",console.log("The password must contain more than 9 characters.");return}if(n.value.length>20){e.innerHTML="The password must contain less than 20 characters.",e.style.display="block",console.log("The password must contain less than 20 characters.");return}if(!t.value.includes("@stud.noroff.no")){e.innerHTML="The email must end with @stud.noroff.no.",e.style.display="block",console.log("The email must end with @stud.noroff.no.");return}if(!/^[a-zA-Z0-9]+$/.test(o.value)){e.innerHTML="The username must only contain letters and numbers.",e.style.display="block",console.log("The username must only contain letters and numbers.");return}const l={name:o.value,email:t.value,bio:"Default bio",avatar:{url:"https://github.com/elanetto/FED1-PE1-elanetto/blob/main/assets/images/user/avatar-user-default.png?raw=true",alt:"User  Avatar"},banner:{url:"https://github.com/elanetto/FED1-PE1-elanetto/blob/main/assets/images/200kb-images/kewater_view-01.jpg?raw=true",alt:"User  Banner"},venueManager:!0,password:n.value};try{const d=await fetch(P,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),m=await d.json();if(console.log(m),m.errors){console.log(m.errors),e.style.display="block",e.innerHTML=m.errors.map(c=>c.message).join("<br>"),console.log(m.errors);return}d.ok&&(r.style.display="block",console.log("User registered successfully."),alert("User registered successfully. You will be redirected to the login page."),setTimeout(()=>{window.location.href="../login/"},2e3))}catch(d){console.log(d),e.style.display="block",e.innerHTML="Something went wrong. Please try again."}document.querySelector(".register-form").reset()})}function x(){const{email:o,password:t,showPasswordBtn:n,errorMessage:s,loginBtn:e}=T();if(!o||!e||!s||!t||!n)return;const r=n.querySelector(".fa-eye-slash"),a=n.querySelector(".fa-eye");if(!r||!a)return;function i(){t.type==="password"?(r.classList.add("hide"),a.classList.remove("hide")):(r.classList.remove("hide"),a.classList.add("hide"))}i(),n.removeEventListener("click",b),n.addEventListener("click",b),e.addEventListener("click",async function(l){var f,p;l.preventDefault();const d=o.value.trim(),m=t.value.trim();if(!C(d)){s.textContent="Email not valid",s.style.display="block";return}if(m.length===0){s.textContent="Please enter a password",s.style.display="block";return}const c={email:d,password:m};try{const u=await fetch(L,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}),g=await u.json();if(u.ok)localStorage.setItem("username",g.data.name),localStorage.setItem("email",g.data.email),localStorage.setItem("avatar",g.data.avatar.url),localStorage.setItem("banner",g.data.banner.url),localStorage.setItem("token",g.data.accessToken),window.location.href="../../account/myaccount/";else{const I=((p=(f=g.errors)==null?void 0:f[0])==null?void 0:p.message)||"An error occurred during login.";s.textContent=I,s.style.display="block"}}catch{s.textContent="An error occurred with your login request.",s.style.display="block"}})}function C(o){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)}function q(){const o=localStorage.getItem("username"),t=localStorage.getItem("email"),n=localStorage.getItem("avatar"),s=localStorage.getItem("banner"),e=localStorage.getItem("credits"),r=localStorage.getItem("listingsCount"),a=localStorage.getItem("winsCount");document.querySelectorAll(".username-from-local-storage").forEach(u=>{o&&(u.textContent=o)}),document.querySelectorAll(".email-from-local-storage").forEach(u=>{t&&(u.textContent=t)});const d=document.querySelector(".avatar-from-local-storage");n&&d&&(d.src=n);const m=document.querySelector(".banner-from-local-storage");s&&m&&(m.src=s),document.querySelectorAll(".my-credits").forEach(u=>{u.innerText=e}),document.querySelectorAll(".my-listings-count").forEach(u=>{u.innerText=r}),document.querySelectorAll(".my-wins-count").forEach(u=>{u.innerText=a})}function v(){const o=localStorage.getItem("token");if(!o){console.error("No token found");return}const t=o.replace(/['"]+/g,""),n=new Headers;return n.append("Authorization",`Bearer ${t}`),fetch("https://v2.api.noroff.dev/auth/create-api-key",{method:"POST",headers:n,redirect:"follow"}).then(e=>{if(!e.ok)throw new Error(`API key request failed: ${e.status} ${e.statusText}`);return e.json()}).then(e=>{var a;const r=(a=e==null?void 0:e.data)==null?void 0:a.key;if(!r)throw new Error("API key not found in response");return localStorage.setItem("api_key",r),r}).catch(e=>(console.error("Error fetching API key:",e),null))}function E(){const o=localStorage.getItem("token"),t=localStorage.getItem("username");if(!o)return null;const n=o.replace(/['"]+/g,"");if(!t)return null;const s=t.replace(/['"]+/g,"");return{cleanedToken:n,cleanedUsername:s}}function U(){const o=E();if(!o){console.warn("Token details are not available. Skipping profile picture setup.");return}const{cleanedToken:t,cleanedUsername:n}=o,s=document.getElementById("avatar-input"),e=document.getElementById("change-avatar-button");if(!s||!e){console.warn("Profile picture input or button not found. Skipping setup.");return}e.addEventListener("click",async r=>{r.preventDefault();const a=s.value.trim();if(!a||!D(a)){alert("Please enter a valid URL.");return}try{const i=await v();if(!i){alert("Unable to fetch API key.");return}const l=new Headers;l.append("Content-Type","application/json"),l.append("X-Noroff-API-Key",i),l.append("Authorization",`Bearer ${t}`);const d=JSON.stringify({avatar:{url:a,alt:"Avatar"}}),m={method:"PUT",headers:l,body:d,redirect:"follow"},c=await fetch(`https://v2.api.noroff.dev/social/profiles/${n}`,m);if(!c.ok)throw console.error("Request failed:",c.status,c.statusText),new Error(`Failed to update profile picture: ${c.status} ${c.statusText}`);const f=await c.json();localStorage.setItem("avatar",a),alert("Your profile picture has been updated!"),location.reload()}catch(i){console.error("An error occurred while updating the profile picture:",i),alert("An error occurred while updating your profile picture.")}})}function D(o){try{return new URL(o),!0}catch{return!1}}function M(){const o=E();if(!o){console.error("Failed to fetch token details.");return}const{cleanedToken:t,cleanedUsername:n}=o;if(!t||!n){console.error("Token or username is missing.");return}const s=document.getElementById("banner-input"),e=document.getElementById("change-banner-button");if(!s||!e){console.error("Required input or button elements are missing.");return}e.addEventListener("click",async r=>{r.preventDefault();const a=s.value.trim();if(!a||!H(a)){alert("Please enter a valid URL."),console.error("Invalid or empty URL:",a);return}try{const i=await v();if(!i){console.error("Failed to fetch API key."),alert("Unable to fetch API key.");return}const l=new Headers;l.append("Content-Type","application/json"),l.append("X-Noroff-API-Key",i),l.append("Authorization",`Bearer ${t}`);const d=JSON.stringify({banner:{url:a,alt:"banner"}}),m={method:"PUT",headers:l,body:d,redirect:"follow"},c=await fetch(`https://v2.api.noroff.dev/social/profiles/${n}`,m);if(!c.ok)throw console.error("Request failed:",c.status,c.statusText),new Error(`Failed to update profile picture: ${c.status} ${c.statusText}`);const f=await c.json();localStorage.setItem("banner",a),alert("Your profile banner has been updated!"),location.reload()}catch(i){console.error("Error updating profile banner:",i),alert("An error occurred while updating your banner.")}})}function H(o){try{return new URL(o),!0}catch{return!1}}const j=()=>{if(document.body.classList.contains("my-account-page")){if(!sessionStorage.getItem("myAccountReloaded")){sessionStorage.setItem("myAccountReloaded","true"),location.reload();return}document.getElementById("avatar-input")&&document.getElementById("change-avatar-button")&&U(),document.getElementById("banner-input")&&document.getElementById("change-banner-button")&&M()}};function O(){if(!document.body.classList.contains("my-account-page"))return;const o=localStorage.getItem("token"),t=localStorage.getItem("api_key"),n=localStorage.getItem("username"),s=o.replace(/['"]+/g,""),e=n.replace(/['"]+/g,"");fetch(`https://v2.api.noroff.dev/auction/profiles/${e}/listings`,{method:"GET",headers:{"X-Noroff-API-Key":t,Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}).then(r=>{if(r.ok)return r.json();throw new Error("Failed to fetch listings")}).then(r=>{const a=r&&Array.isArray(r.data)?r.data:[];if(!Array.isArray(a)||a.length===0)return;const i=document.getElementById("listings-container");if(!i){console.error("Listings container not found in DOM");return}a.forEach(l=>{var g;const d=document.createElement("div");d.classList.add("flex","flex-col","p-4","bg-white","w-[350px]","rounded","shadow-md");const m=l.media&&l.media[0]&&l.media[0].url?l.media[0].url:"default-image.jpg",c=l.tags||[],f=(g=l.bids)!=null&&g.length?l.bids[l.bids.length-1].amount:"0",p=l.endsAt;let u="N/A";if(p){const y=new Date(p)-new Date;if(y>0){const h=Math.floor(y/864e5),w=Math.floor(y%(1e3*60*60*24)/(1e3*60*60)),k=Math.floor(y%(1e3*60*60)/(1e3*60));h>0?u=`${h} day${h>1?"s":""}`:w>0?u=`${w} hour${w>1?"s":""}`:u=`${k} minute${k>1?"s":""}`}else u="Ended"}d.innerHTML=`
                <img src="${m}" alt="${l.title}" class="mb-4 rounded">
                <h3 class="text-blue-950 font-bold text-lg">${l.title}</h3>
                <div>
                    <span class="text-blue-950 font-bold">Current Bid:</span>
                    <span>${f} 🌕</span>
                </div>
                <div>
                    <span class="text-blue-950 font-bold">Description:</span>
                    <span class="italic">${l.description}</span>
                </div>
                <div>
                    <span class="text-blue-950 font-bold">Category:</span>
                    <span>${c||"N/A"}</span>
                </div>
                <div>
                    <span class="text-blue-950 font-bold">Ends in:</span>
                    <span>${u}</span>
                </div>
                <div class="mt-3">
                    <button class="bg-blue-950 hover:bg-blue-800 text-white rounded px-6 py-2">Edit</button>
                    <button class="bg-blue-950 hover:bg-blue-800 text-white rounded px-6 py-2 mt-2">Delete</button>
                </div>
            `,i.appendChild(d)})}).catch(r=>{console.error("Error fetching listings:",r)})}async function N(){const o=localStorage.getItem("token"),t=localStorage.getItem("username"),n=localStorage.getItem("api_key");if(console.log("username: ",t),console.log("token: ",o),console.log("apiKey: ",n),!o)return console.error("No token found. User may not be logged in."),null;const s=new Headers;s.append("Authorization",`Bearer ${o}`),s.append("X-Noroff-API-Key",n);const e={method:"GET",headers:s,redirect:"follow"};try{const r=await fetch(`https://v2.api.noroff.dev/auction/profiles/${t}`,e);if(!r.ok)throw new Error(`Failed to fetch profile data: ${r.status} ${r.statusText}`);const a=await r.json(),i={name:a.data.name,email:a.data.email,credits:a.data.credits,listingsCount:a.data._count.listings,winsCount:a.data._count.wins};return localStorage.setItem("credits",a.data.credits),localStorage.setItem("listingsCount",a.data._count.listings),localStorage.setItem("winsCount",a.data._count.wins),i}catch(r){return console.error("Error fetching profile data:",r),null}}document.addEventListener("DOMContentLoaded",async function(){T(),x(),q(),N(),(document.getElementById("register-form")?A():null)&&$();const t=localStorage.getItem("username");if(!t)return;const n=t.replace(/['"]+/g,""),s=document.querySelector(".logged-in-username");s&&(s.textContent=`Hello, ${n}! You are currently logged in.`),document.querySelectorAll(".visible-if-logged-in").forEach(r=>{r&&(r.style.display="block")}),j();try{await Promise.all([E(),v()]),O()}catch(r){console.error("Error fetching required data:",r)}});
